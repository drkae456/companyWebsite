{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<main class="pt-6 px-3 mt-3">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="text-light">Upskilling Skills</h1>
    <div>
      {% if user.is_staff %}
      <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#createCourseModal">
        <i class="fas fa-plus me-2"></i>Create Official Course
      </button>
      {% endif %}
      {% if user.is_authenticated %}
      <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal"
        data-bs-target="#createPersonalCourseModal">
        <i class="fas fa-user-plus me-2"></i>Create Personal Course
      </button>
      {% endif %}
    </div>
  </div>

  <div class="row mt-4 pb-5" id="skill-cards">
    {% for skill in skills %}
    <div class="col-md-4 mb-4">
      <div class="card bg-dark text-white h-100 shadow-sm border-warning border-1 rounded-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title text-warning mb-0">{{ skill.title }}</h5>
            {% if skill.visibility == 'personal' %}
            <span class="badge bg-info">Personal</span>
            {% elif skill.visibility == 'pending' %}
            <span class="badge bg-warning text-dark">Pending Approval</span>
            {% endif %}
          </div>
          <p class="card-text">
            <strong>Difficulty:</strong> {{ skill.difficulty }}<br>
            <strong>Tags:</strong>
            {% for tag in skill.tags %}
            <span class="badge bg-secondary">{{ tag }}</span>
            {% endfor %}
            <br>
            <strong>Status:</strong> {{ skill.status }}
            {% if skill.certificate_status %}
            <br>
            <strong>Certificate:</strong>
            {% if skill.certificate_status == 'pending' %}
            <span class="badge bg-warning text-dark">Pending Review</span>
            {% elif skill.certificate_status == 'verified' %}
            <span class="badge bg-success">Verified</span>
            {% elif skill.certificate_status == 'rejected' %}
            <span class="badge bg-danger">Rejected</span>
            {% endif %}
            {% endif %}
          </p>

          <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="d-flex flex-column">
              {% if skill.status == "Completed" %}
              <button class="btn btn-secondary btn-sm mt-2" disabled>Completed</button>
              {% elif skill.status == "In Progress" %}
              {% if skill.external_link %}
              <a href="{{ skill.external_link }}" target="_blank" class="btn btn-warning btn-sm mt-2">
                Continue <i class="fas fa-external-link-alt ms-1"></i>
              </a>
              {% else %}
              <a href="{% url 'upskilling_skill' slug=skill.slug %}" class="btn btn-warning btn-sm mt-2">Continue</a>
              {% endif %}
              {% if not skill.certificate_status %}
              <button class="btn btn-outline-success btn-sm mt-1"
                onclick="showCertificateModal('{{ skill.slug }}', '{{ skill.title }}', '{{ skill.visibility|default:'official' }}')">
                <i class="fas fa-certificate me-1"></i>Upload Certificate
              </button>
              {% elif skill.certificate_status == 'pending' %}
              <button class="btn btn-outline-warning btn-sm mt-1" disabled>
                <i class="fas fa-clock me-1"></i>Certificate Under Review
              </button>
              {% elif skill.certificate_status == 'rejected' %}
              <button class="btn btn-outline-danger btn-sm mt-1"
                onclick="showCertificateModal('{{ skill.slug }}', '{{ skill.title }}', '{{ skill.visibility|default:'official' }}')">
                <i class="fas fa-redo me-1"></i>Re-upload Certificate
              </button>
              {% endif %}
              {% else %}
              {% if skill.external_link %}
              <a href="{% url 'start_external_skill' slug=skill.slug %}" target="_blank"
                class="btn btn-success btn-sm mt-2">
                Start <i class="fas fa-external-link-alt ms-1"></i>
              </a>
              {% else %}
              <a href="{% url 'upskilling_skill' slug=skill.slug %}" class="btn btn-success btn-sm mt-2">Start</a>
              {% endif %}
              {% endif %}
            </div>
            {% if user.is_staff %}
            <div class="btn-group" role="group">
              <button class="btn btn-outline-warning btn-sm mt-2"
                onclick="editCourse('{{ skill.id|default_if_none:'' }}', '{{ skill.title|escapejs }}', '{{ skill.description|escapejs }}', '{{ skill.external_link|escapejs }}', '{{ skill.difficulty|escapejs }}', JSON.parse('{{ skill.tags|default_if_none:'[]'|escapejs }}'), '{% if skill.badge %}{{ skill.badge.url }}{% endif %}');">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-outline-danger btn-sm mt-2"
                onclick="deleteCourse('{{ skill.id|default_if_none:'' }}', '{{ skill.title|escapejs }}');">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div style="height: 150px;"></div>
</main>

<!-- Create Course Modal -->
{% if user.is_staff %}
<div class="modal fade" id="createCourseModal" tabindex="-1" aria-labelledby="createCourseModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="createCourseModalLabel">
          <i class="fas fa-plus me-2"></i>Create New Course
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="createCourseForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="courseTitle" class="form-label">Course Title</label>
            <input type="text" class="form-control bg-dark text-white border-secondary" id="courseTitle" required
              placeholder="Enter course title...">
          </div>
          <div class="mb-3">
            <label for="courseDescription" class="form-label">Description</label>
            <textarea class="form-control bg-dark text-white border-secondary" id="courseDescription" rows="3"
              placeholder="Enter course description..."></textarea>
          </div>
          <div class="mb-3">
            <label for="courseLink" class="form-label">External Course URL</label>
            <input type="url" class="form-control bg-dark text-white border-secondary" id="courseLink" required
              placeholder="https://example.com/course">
            <div class="form-text text-muted">Link to external course website</div>
          </div>
          <div class="mb-3">
            <label for="courseDifficulty" class="form-label">Difficulty Level</label>
            <select class="form-select bg-dark text-white border-secondary" id="courseDifficulty">
              <option value="Beginner">Beginner</option>
              <option value="Intermediate">Intermediate</option>
              <option value="Advanced">Advanced</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="courseTags" class="form-label">Tags (comma-separated)</label>
            <input type="text" class="form-control bg-dark text-white border-secondary" id="courseTags"
              placeholder="e.g. Python, Web Dev, Security">
            <div class="form-text text-muted">Enter tags separated by commas</div>
          </div>
          <div class="mb-3">
            <label for="courseBadge" class="form-label">Completion Badge (Optional)</label>
            <input type="file" class="form-control bg-dark text-white border-secondary" id="courseBadge"
              accept=".png,.jpg,.jpeg,.svg">
            <div class="form-text text-muted">Upload a badge image for course completion (PNG, JPG, or SVG)</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="createCourse()">
          <i class="fas fa-save me-2"></i>Create Course
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Delete Course Modal -->
{% if user.is_staff %}
<div class="modal fade" id="deleteCourseModal" tabindex="-1" aria-labelledby="deleteCourseModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteCourseModalLabel">
          <i class="fas fa-exclamation-triangle text-danger me-2"></i>Delete Course
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> This action cannot be undone.
        </div>
        <p>Are you sure you want to delete the course "<span id="deleteCourseTitle"></span>"?</p>
        <input type="hidden" id="deleteCourseId">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmDeleteCourse()">
          <i class="fas fa-trash me-2"></i>Delete Course
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Edit Course Modal -->
{% if user.is_staff %}
<div class="modal fade" id="editCourseModal" tabindex="-1" aria-labelledby="editCourseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="editCourseModalLabel">
          <i class="fas fa-edit me-2"></i>Edit Course
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editCourseForm" enctype="multipart/form-data">
          <input type="hidden" id="editCourseId">

          <div class="mb-3">
            <label for="editCourseTitle" class="form-label">Course Title</label>
            <input type="text" class="form-control bg-dark text-white border-secondary" id="editCourseTitle" required
              placeholder="Enter course title...">
          </div>
          <div class="mb-3">
            <label for="editCourseDescription" class="form-label">Description</label>
            <textarea class="form-control bg-dark text-white border-secondary" id="editCourseDescription" rows="3"
              placeholder="Enter course description..."></textarea>
          </div>
          <div class="mb-3">
            <label for="editCourseLink" class="form-label">External Course URL</label>
            <input type="url" class="form-control bg-dark text-white border-secondary" id="editCourseLink" required
              placeholder="https://example.com/course">
            <div class="form-text text-muted">Link to external course website</div>
          </div>
          <div class="mb-3">
            <label for="editCourseDifficulty" class="form-label">Difficulty Level</label>
            <select class="form-select bg-dark text-white border-secondary" id="editCourseDifficulty">
              <option value="Beginner">Beginner</option>
              <option value="Intermediate">Intermediate</option>
              <option value="Advanced">Advanced</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editCourseTags" class="form-label">Tags (comma-separated)</label>
            <input type="text" class="form-control bg-dark text-white border-secondary" id="editCourseTags"
              placeholder="e.g. Python, Web Dev, Security">
            <div class="form-text text-muted">Enter tags separated by commas</div>
          </div>
          <div class="mb-3">
            <label for="editCourseBadge" class="form-label">Completion Badge (Optional)</label>
            <input type="file" class="form-control bg-dark text-white border-secondary" id="editCourseBadge"
              accept=".png,.jpg,.jpeg,.svg">
            <div class="form-text text-muted">Upload a new badge image or leave empty to keep existing badge</div>
            <div id="currentBadgeInfo" class="form-text text-info mt-2" style="display: none;">
              Current badge: <span id="currentBadgeName"></span>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="updateCourse()">
          <i class="fas fa-save me-2"></i>Update Course
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Certificate Upload Modal -->
<div class="modal fade" id="certificateUploadModal" tabindex="-1" aria-labelledby="certificateUploadModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="certificateUploadModalLabel">
          <i class="fas fa-certificate me-2"></i>Upload Certificate
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="certificateUploadForm" enctype="multipart/form-data">
          <input type="hidden" id="certificateSkillSlug">

          <div class="mb-3">
            <label for="certificateProvider" class="form-label">Certificate Provider</label>
            <select class="form-select bg-dark text-white border-secondary" id="certificateProvider" name="provider">
              <option value="linkedin">LinkedIn Learning</option>
              <option value="microsoft">Microsoft Learn</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="certificateFile" class="form-label">Certificate File</label>
            <input type="file" class="form-control bg-dark text-white border-secondary" id="certificateFile"
              name="certificate_file" accept=".pdf,.png,.jpg,.jpeg" required>
            <div class="form-text text-muted">Upload your certificate (PDF, PNG, or JPG files only)</div>
          </div>

          <div class="mb-3">
            <label for="certificateUrl" class="form-label">Certificate URL (Optional)</label>
            <input type="url" class="form-control bg-dark text-white border-secondary" id="certificateUrl"
              name="certificate_url" placeholder="https://example.com/verify-certificate">
            <div class="form-text text-muted">Link to verify certificate online (for LinkedIn/Microsoft certificates)
            </div>
          </div>

          <div class="mb-3">
            <label for="certificateId" class="form-label">Certificate ID (Optional)</label>
            <input type="text" class="form-control bg-dark text-white border-secondary" id="certificateId"
              name="certificate_id" placeholder="Certificate or credential ID">
            <div class="form-text text-muted">Certificate ID or credential number if available</div>
          </div>

          <div class="mb-3" id="requestOfficialSection" style="display: none;">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="requestOfficial" name="request_official">
              <label class="form-check-label" for="requestOfficial">
                <strong>Request to make this course official</strong>
              </label>
              <div class="form-text text-muted">Check this box to request admin approval to make your personal course
                available to all HardHat users</div>
            </div>
          </div>

          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Verification Guidelines:</strong>
            <ul class="mb-0 mt-2">
              <li>For <strong>LinkedIn Learning</strong>: Include the certificate URL from your LinkedIn profile</li>
              <li>For <strong>Microsoft Learn</strong>: Include the credential URL from Microsoft Learn</li>
              <li>Ensure certificate clearly shows your name and the completed course</li>
              <li>Your certificate will be reviewed by our staff within 1-2 business days</li>
            </ul>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="uploadCertificate()">
          <i class="fas fa-upload me-2"></i>Upload Certificate
        </button>
      </div>
    </div>
  </div>
</div>

{% if user.is_staff %}
<script>
  function createCourse() {
    const title = document.getElementById('courseTitle').value;
    const description = document.getElementById('courseDescription').value;
    const externalLink = document.getElementById('courseLink').value;
    const difficulty = document.getElementById('courseDifficulty').value;
    const tagsInput = document.getElementById('courseTags').value;
    const badgeFile = document.getElementById('courseBadge').files[0];

    if (!title || !externalLink) {
      alert('Please fill in the required fields (Title and External URL)');
      return;
    }

    // Parse tags
    const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);

    // Use FormData for file upload
    const formData = new FormData();
    formData.append('title', title);
    formData.append('description', description);
    formData.append('external_link', externalLink);
    formData.append('difficulty', difficulty);
    formData.append('tags', JSON.stringify(tags));
    if (badgeFile) {
      formData.append('badge', badgeFile);
    }

    fetch('{% url "create_upskilling_course" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: formData
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the course');
      });
  }

  function deleteCourse(courseId, courseTitle) {
    document.getElementById('deleteCourseId').value = courseId;
    document.getElementById('deleteCourseTitle').textContent = courseTitle;

    var deleteModal = new bootstrap.Modal(document.getElementById('deleteCourseModal'));
    deleteModal.show();
  }

  function confirmDeleteCourse() {
    const courseId = document.getElementById('deleteCourseId').value;

    fetch(`{% url "delete_upskilling_course" course_id=0 %}`.replace('0', courseId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the course');
      });
  }

  function editCourse(courseId, title, description, externalLink, difficulty, tags, badgeUrl) {
    document.getElementById('editCourseId').value = courseId;
    document.getElementById('editCourseTitle').value = title;
    document.getElementById('editCourseDescription').value = description || '';
    document.getElementById('editCourseLink').value = externalLink || '';
    document.getElementById('editCourseDifficulty').value = difficulty || 'Beginner';

    // Handle tags - convert array to comma-separated string
    let tagsString = '';
    if (Array.isArray(tags) && tags.length > 0) {
      tagsString = tags.join(', ');
    }
    document.getElementById('editCourseTags').value = tagsString;

    // Handle badge info
    const currentBadgeInfo = document.getElementById('currentBadgeInfo');
    const currentBadgeName = document.getElementById('currentBadgeName');
    if (badgeUrl) {
      const badgeName = badgeUrl.split('/').pop();
      currentBadgeName.textContent = badgeName;
      currentBadgeInfo.style.display = 'block';
    } else {
      currentBadgeInfo.style.display = 'none';
    }

    var editModal = new bootstrap.Modal(document.getElementById('editCourseModal'));
    editModal.show();
  }

  function updateCourse() {
    const courseId = document.getElementById('editCourseId').value;
    const title = document.getElementById('editCourseTitle').value;
    const description = document.getElementById('editCourseDescription').value;
    const externalLink = document.getElementById('editCourseLink').value;
    const difficulty = document.getElementById('editCourseDifficulty').value;
    const tagsInput = document.getElementById('editCourseTags').value;
    const badgeFile = document.getElementById('editCourseBadge').files[0];

    if (!title || !externalLink) {
      alert('Please fill in the required fields (Title and External URL)');
      return;
    }

    // Parse tags
    const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);

    // Use FormData for file upload
    const formData = new FormData();
    formData.append('title', title);
    formData.append('description', description);
    formData.append('external_link', externalLink);
    formData.append('difficulty', difficulty);
    formData.append('tags', JSON.stringify(tags));
    if (badgeFile) {
      formData.append('badge', badgeFile);
    }

    // Show loading state
    const updateBtn = document.querySelector('[onclick="updateCourse()"]');
    const originalText = updateBtn.innerHTML;
    updateBtn.disabled = true;
    updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';

    fetch(`{% url "edit_upskilling_course" course_id=0 %}`.replace('0', courseId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: formData
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          bootstrap.Modal.getInstance(document.getElementById('editCourseModal')).hide();
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the course');
      })
      .finally(() => {
        // Reset button state
        updateBtn.disabled = false;
        updateBtn.innerHTML = originalText;
      });
  }
</script>
{% endif %}

<!-- Create Personal Course Modal -->
<div class="modal fade" id="createPersonalCourseModal" tabindex="-1" aria-labelledby="createPersonalCourseModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title" id="createPersonalCourseModalLabel">
          <i class="fas fa-user-plus me-2"></i>Create Personal Course
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Personal Course:</strong> This course will be visible only to you. After completing it and submitting
          a certificate, you can request admin approval to make it an official HardHat course for everyone.
        </div>
        <form id="createPersonalCourseForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="personalCourseTitle" class="form-label">Course Title</label>
            <input type="text" class="form-control bg-dark text-white border-secondary" id="personalCourseTitle"
              required placeholder="Enter course title...">
          </div>
          <div class="mb-3">
            <label for="personalCourseDescription" class="form-label">Description</label>
            <textarea class="form-control bg-dark text-white border-secondary" id="personalCourseDescription" rows="3"
              placeholder="Enter course description..."></textarea>
          </div>
          <div class="mb-3">
            <label for="personalCourseLink" class="form-label">External Course URL</label>
            <input type="url" class="form-control bg-dark text-white border-secondary" id="personalCourseLink" required
              placeholder="https://example.com/course">
            <div class="form-text text-muted">Link to external course website</div>
          </div>
          <div class="mb-3">
            <label for="personalCourseDifficulty" class="form-label">Difficulty Level</label>
            <select class="form-select bg-dark text-white border-secondary" id="personalCourseDifficulty">
              <option value="Beginner">Beginner</option>
              <option value="Intermediate">Intermediate</option>
              <option value="Advanced">Advanced</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="personalCourseTags" class="form-label">Tags (comma-separated)</label>
            <input type="text" class="form-control bg-dark text-white border-secondary" id="personalCourseTags"
              placeholder="e.g. Python, Web Dev, Security">
            <div class="form-text text-muted">Enter tags separated by commas</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="createPersonalCourse()">
          <i class="fas fa-save me-2"></i>Create Personal Course
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Personal course creation
  function createPersonalCourse() {
    const title = document.getElementById('personalCourseTitle').value;
    const description = document.getElementById('personalCourseDescription').value;
    const externalLink = document.getElementById('personalCourseLink').value;
    const difficulty = document.getElementById('personalCourseDifficulty').value;
    const tagsInput = document.getElementById('personalCourseTags').value;

    if (!title || !externalLink) {
      alert('Please fill in the required fields (Title and External URL)');
      return;
    }

    // Parse tags
    const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);

    // Use FormData for consistency
    const formData = new FormData();
    formData.append('title', title);
    formData.append('description', description);
    formData.append('external_link', externalLink);
    formData.append('difficulty', difficulty);
    formData.append('tags', JSON.stringify(tags));

    fetch('{% url "create_personal_course" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: formData
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the personal course');
      });
  }

  // Certificate upload functionality
  function showCertificateModal(skillSlug, skillTitle, skillVisibility = 'official') {
    document.getElementById('certificateSkillSlug').value = skillSlug;
    document.getElementById('certificateUploadModalLabel').innerHTML = `<i class="fas fa-certificate me-2"></i>Upload Certificate - ${skillTitle}`;

    // Reset form
    document.getElementById('certificateUploadForm').reset();
    document.getElementById('certificateSkillSlug').value = skillSlug;

    // Show request official section only for personal courses
    const requestOfficialSection = document.getElementById('requestOfficialSection');
    if (skillVisibility === 'personal') {
      requestOfficialSection.style.display = 'block';
    } else {
      requestOfficialSection.style.display = 'none';
    }

    var modal = new bootstrap.Modal(document.getElementById('certificateUploadModal'));
    modal.show();
  }

  function uploadCertificate() {
    const skillSlug = document.getElementById('certificateSkillSlug').value;
    const form = document.getElementById('certificateUploadForm');
    const formData = new FormData(form);

    // Validate file
    const fileInput = document.getElementById('certificateFile');
    if (!fileInput.files[0]) {
      alert('Please select a certificate file to upload');
      return;
    }

    // Check file size (5MB limit)
    if (fileInput.files[0].size > 5 * 1024 * 1024) {
      alert('File size must be less than 5MB');
      return;
    }

    // Show loading state
    const uploadBtn = document.querySelector('[onclick="uploadCertificate()"]');
    const originalText = uploadBtn.innerHTML;
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';

    fetch(`{% url "upload_certificate" skill_slug="dummy" %}`.replace('dummy', skillSlug), {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: formData
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          bootstrap.Modal.getInstance(document.getElementById('certificateUploadModal')).hide();
          // Optionally reload page to update UI
          // location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while uploading the certificate');
      })
      .finally(() => {
        // Reset button state
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = originalText;
      });
  }
</script>

{% endblock %}